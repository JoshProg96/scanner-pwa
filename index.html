<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hope Awakened Scanner</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
    body { margin:0; background:#000; color:#fff; overflow:hidden; font-family:sans-serif; }

    video {
        position:fixed;
        inset:0;
        width:100vw;
        height:100vh;
        object-fit:cover;
        background:#000;
    }

    #frame {
        position:fixed;
        top:50%; left:50%;
        width:70%; height:35%;
        border:4px solid rgba(255,255,255,0.85);
        border-radius:14px;
        transform:translate(-50%,-50%);
        box-shadow:0 0 20px rgba(255,255,255,0.55);
    }

    #result-box {
        position:fixed;
        bottom:0; width:100%; padding:20px;
        font-size:26px; font-weight:bold;
        text-align:center;
        display:none; color:white;
    }

    #status {
        position:fixed; top:10px; right:12px;
        background:rgba(0,0,0,0.6);
        padding:8px 12px;
        border-radius:8px;
        font-size:14px;
    }

    #offline-warning {
        position:fixed;
        top:0; width:100%;
        background:#ffcc00; color:#000;
        padding:10px; text-align:center;
        display:none;
        font-weight:bold;
    }
</style>

</head>
<body>

<div id="offline-warning">⚠ Tidak ada koneksi internet.</div>
<div id="status">Loading camera…</div>

<video id="video" autoplay playsinline webkit-playsinline muted></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="frame"></div>
<div id="result-box"></div>

<!-- jsQR fallback -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
/* REMOVE ALL SW FOR CAMERA STABILITY */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs =>
        regs.forEach(r => r.unregister())
    );
}

/* Internet Warning */
setInterval(() => {
    document.getElementById("offline-warning").style.display =
        navigator.onLine ? "none" : "block";
}, 800);

const VERIFY_URL =
 "https://script.google.com/macros/s/AKfycbw47LANRHx7VwAX_bzmviZdNEG4YlA2jThpa805CHT_AzewLukBarjMTIIDLEKzJ5G7ww/exec";

let lastScan = 0;
let isProcessing = false;
const COOLDOWN = 2000;

function vibrate(ms=80){
    if (navigator.vibrate) navigator.vibrate(ms);
}

function showResult(text, color){
    const box = document.getElementById("result-box");
    box.innerText = text;
    box.style.background = color;
    box.style.display = "block";
}

/* Start Camera */
async function startCamera(){
    const video = document.getElementById("video");
    const statusBox = document.getElementById("status");

    statusBox.innerText = "Opening camera…";

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode:"environment" },
            audio:false
        });

        video.srcObject = stream;

        video.onloadedmetadata = () => {
            video.play();
            setTimeout(() => {
                statusBox.innerText = "Camera Ready";
                requestAnimationFrame(scanLoop);
            }, 300);
        };

    } catch (e){
        alert("Tidak bisa membuka kamera. Pastikan izin kamera aktif.");
    }
}

/* MAIN LOOP */
async function scanLoop(){
    const video = document.getElementById("video");

    if (video.readyState !== 4) {
        return requestAnimationFrame(scanLoop);
    }

    const now = Date.now();
    if (now - lastScan < COOLDOWN || isProcessing){
        return requestAnimationFrame(scanLoop);
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.filter = "contrast(180%) brightness(115%)";
    ctx.drawImage(video, 0, 0);
    ctx.filter = "none";

    /* TRY 1: BarcodeDetector */
    if ("BarcodeDetector" in window){
        try {
            const detector = new BarcodeDetector({ formats:["qr_code"] });
            const codes = await detector.detect(canvas);
            if (codes.length > 0){
                return processQR(codes[0].rawValue);
            }
        } catch(_) {}
    }

    /* TRY 2: jsQR */
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data, canvas.width, canvas.height);

    if (code){
        return processQR(code.data);
    }

    requestAnimationFrame(scanLoop);
}

/* PROCESS QR */
async function processQR(text){
    const now = Date.now();
    if (now - lastScan < COOLDOWN || isProcessing) return;

    lastScan = now;
    isProcessing = true;

    vibrate();
    showResult("⏳ Checking…", "#222");

    try {
        const res = await fetch(`${VERIFY_URL}?code=${encodeURIComponent(text)}`, {
            cache:"no-store"
        });

        const html = (await res.text()).toLowerCase();

        if (html.includes("tiket valid"))
            showResult("✅ Tiket Valid","#00cc66");

        else if (html.includes("sudah dipakai"))
            showResult("❌ Sudah Dipakai","#cc0000");

        else if (html.includes("tidak ditemukan"))
            showResult("❌ Tidak Ditemukan","#cc0000");

        else if (html.includes("belum aktif"))
            showResult("⏳ Belum Aktif","#ffaa00");

        else
            showResult("⚠ Error","#ffaa00");

    } catch(e){
        showResult("⚠ Koneksi bermasalah","#ffaa00");
    }

    setTimeout(() => {
        document.getElementById("result-box").style.display = "none";
        isProcessing = false;
    }, COOLDOWN);

    requestAnimationFrame(scanLoop);
}

document.addEventListener("DOMContentLoaded", startCamera);
</script>

</body>
</html>
